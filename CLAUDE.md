# VoiceX é¡¹ç›®å¼€å‘è®°å½•

## é¡¹ç›®æ¦‚è¿°
VoiceX æ˜¯ä¸€ä¸ªåŸºäº FunASR å’Œ Docker çš„ macOS å®æ—¶å¬å†™åº”ç”¨,é‡‡ç”¨"Worker-Client"ä¸¤å±‚æ¶æ„ã€‚

## ç¬¬ä¸€é˜¶æ®µï¼šWorker æ ¸å¿ƒå¼•æ“ âœ… å®Œæˆ (2025-08-04)

### æ ¸å¿ƒé…ç½®
- **æœåŠ¡**: `funasr-wss-server-2pass` 
- **ç«¯å£**: localhost:10096 â†’ å®¹å™¨10095
- **æ¨¡å‹**: offline + online åŒæ¨¡å‹2passæ¨¡å¼
- **åè®®**: WebSocket + 2pass streaming

### å…³é”®æ–‡ä»¶
```
/worker/
â”œâ”€â”€ start_server.sh        # 2passæœåŠ¡å¯åŠ¨è„šæœ¬
â”œâ”€â”€ run_worker.sh          # å®¹å™¨ç®¡ç†è„šæœ¬  
â””â”€â”€ Dockerfile             # é•œåƒæ„å»º

/tests/
â”œâ”€â”€ test_streaming.py      # æµå¼è¯†åˆ«æµ‹è¯•å®¢æˆ·ç«¯
â””â”€â”€ test2.wav             # æµ‹è¯•éŸ³é¢‘(16k,16bit,mono)
```

### æŠ€æœ¯è¦ç‚¹
1. **2passæ¨¡å¼**: åŒæ—¶é…ç½®`--model-dir`(offline)å’Œ`--online-model-dir`(online)
2. **å®¢æˆ·ç«¯åè®®**: ä½¿ç”¨`"mode": "2pass", "chunk_size": [5,10,5]`
3. **å®æ—¶æ€§èƒ½**: æ¯1-2ç§’è¿”å›ä¸­é—´ç»“æœï¼Œæ¨¡å¼`2pass-online`

### éªŒè¯æˆåŠŸ
```bash
cd tests && python3 test_streaming.py --audio_in test2.wav
# ç»“æœ: 97ä¸ªå®æ—¶ä¸­é—´ç»“æœ + é«˜ç²¾åº¦æœ€ç»ˆç»“æœ
```

## æ¶æ„å†³ç­– (2025-08-04)

### ç¬¬äºŒé˜¶æ®µï¼šSupervisor å®ˆæŠ¤æœåŠ¡ âŒ è·³è¿‡
**å†³ç­–**: ç»è¿‡è¯„ä¼°,è®¤ä¸ºlaunchdå®ˆæŠ¤æœåŠ¡å¤æ‚åº¦è¿‡é«˜ï¼Œä¸é€‚åˆä¸ªäººé¡¹ç›®  
**åŸå› **: Dockeræœ¬èº«å…·å¤‡é‡å¯æœºåˆ¶(`--restart=unless-stopped`),æ‰‹åŠ¨ç®¡ç†æ›´åŠ çµæ´»ç®€å•

## ç¬¬ä¸‰é˜¶æ®µï¼šClient å®¢æˆ·ç«¯åº”ç”¨ âœ… å®Œæˆ (2025-08-04)

### æ ¸å¿ƒç»„ä»¶
- **WebSocketManager.swift**: åŸºäºtest_streaming.pyçš„WebSocketé€šä¿¡
- **AudioRecorder.swift**: macOSéŸ³é¢‘å½•åˆ¶+æ ¼å¼è½¬æ¢(48kHzâ†’16kHz)
- **VoiceRecognitionController.swift**: å½•éŸ³ä¸è¯†åˆ«æµç¨‹ç®¡ç†
- **ContentView.swift**: SwiftUIå®æ—¶è¯­éŸ³è¯†åˆ«ç•Œé¢

### æŠ€æœ¯è¦ç‚¹
1. **éŸ³é¢‘æ ¼å¼è½¬æ¢**: ç¡¬ä»¶48kHz Float32 â†’ 16kHz Int16 (FunASRå…¼å®¹)
2. **æƒé™é…ç½®**: ç½‘ç»œè®¿é—®+éº¦å…‹é£æƒé™(macOSæ²™ç›’)
3. **åè®®å¤ç”¨**: ç›´æ¥ä½¿ç”¨éªŒè¯æˆåŠŸçš„2pass WebSocketåè®®
4. **å®æ—¶å¤„ç†**: 100msä½å»¶è¿ŸéŸ³é¢‘å—ä¼ è¾“
### éªŒè¯æˆåŠŸ
```bash
cd client/VoiceX && xcodebuild build
# ç»“æœ: æ„å»ºæˆåŠŸï¼Œå¯æ­£å¸¸è¿æ¥Workerå¹¶è¿›è¡Œå®æ—¶è¯­éŸ³è¯†åˆ«
```

## ç¬¬å››é˜¶æ®µï¼šå…¨å±€å…‰æ ‡æ³¨å…¥åŠŸèƒ½ âœ… åŸºæœ¬å®Œæˆ (2025-08-05)

### æ ¸å¿ƒå®ç°
- **TextInjectionManager.swift**: åŸºäºCGEventçš„è·¨åº”ç”¨æ–‡æœ¬æ³¨å…¥å¼•æ“
- **è¾…åŠ©åŠŸèƒ½æƒé™**: ç¦ç”¨macOSæ²™ç›’ï¼ŒæˆåŠŸè·å–ç³»ç»Ÿçº§æ–‡æœ¬è¾“å…¥æƒé™
- **å®æ—¶æ³¨å…¥**: è¯­éŸ³è¯†åˆ«ç»“æœç›´æ¥æ³¨å…¥åˆ°ä»»æ„åº”ç”¨çš„å…‰æ ‡ä½ç½®

### æŠ€æœ¯çªç ´
1. **æƒé™è§£å†³æ–¹æ¡ˆ**: `app-sandbox = false` â†’ æ­£å¸¸å¼¹å‡ºè¾…åŠ©åŠŸèƒ½æƒé™è¯·æ±‚
2. **CGEventæ–‡æœ¬æ³¨å…¥**: UTF-16ç¼–ç  + keyboardSetUnicodeString API
3. **å®æ—¶æµå¼å¤„ç†**: ç§»é™¤"æœ€ç»ˆç»“æœ"ç­‰å¾…é€»è¾‘ï¼Œç›´æ¥å¤„ç†ä¸­é—´ç»“æœ

### å…³é”®Debugè¿‡ç¨‹ (2025-08-05)
**é—®é¢˜**: æ–‡æœ¬æ³¨å…¥åŠŸèƒ½å¤±æ•ˆ
```
ã€ä¸­é—´ã€‘ è¯†åˆ«ç»“æœ: æ³¨å…¥
ğŸ“ è¯†åˆ«ç»“æœå¤„ç†:
   - isFinal: false
   - textInjectionManagerå­˜åœ¨: true  
   - æ³¨å…¥å·²å¯ç”¨: true
â­ï¸ è·³è¿‡æ³¨å…¥ - æ¡ä»¶ä¸æ»¡è¶³
```

**æ ¹æœ¬åŸå› **: 
- âŒ **é”™è¯¯é€»è¾‘**: ç­‰å¾… `isFinal: true` çš„æœ€ç»ˆç»“æœ
- âœ… **æ­£ç¡®é€»è¾‘**: å®æ—¶æµå¼24hè¯­éŸ³è¯†åˆ«æœ¬èº«æ²¡æœ‰"æœ€ç»ˆç»“æœ"æ¦‚å¿µ

**è§£å†³æ–¹æ¡ˆ**:
```swift
// ä¿®æ”¹å‰ï¼šåªæ³¨å…¥æœ€ç»ˆç»“æœ
if textInjectionManager.isInjectionEnabled && isFinal {
    textInjectionManager.injectText(text)
}

// ä¿®æ”¹åï¼šæ³¨å…¥æ‰€æœ‰ç»“æœä½†å»é‡
if textInjectionManager.isInjectionEnabled && 
   text != lastInjectedText && !text.isEmpty {
    textInjectionManager.injectText(text)  
    lastInjectedText = text
}
```

### å½“å‰çŠ¶æ€
- âœ… åŸºæœ¬æ³¨å…¥åŠŸèƒ½å·¥ä½œæ­£å¸¸
- âš ï¸ **é—ç•™é—®é¢˜**: ä»æœ‰é‡å¤æ³¨å…¥ç°è±¡ï¼ˆæ³¨å…¥ä¸¤éï¼‰ !!!é‡è¦
- ğŸ¯ **ä¸‹æ¬¡ä¼˜åŒ–**: è¿›ä¸€æ­¥å®Œå–„å»é‡é€»è¾‘

### éªŒè¯æˆåŠŸ
- å¯åœ¨ä»»æ„åº”ç”¨ï¼ˆæµè§ˆå™¨ã€ç»ˆç«¯ã€ç¼–è¾‘å™¨ï¼‰ä¸­è¿›è¡Œè¯­éŸ³è½¬æ–‡å­—
- è¾…åŠ©åŠŸèƒ½æƒé™é…ç½®æˆåŠŸ
- è·¨åº”ç”¨æ–‡æœ¬æ³¨å…¥æŠ€æœ¯éªŒè¯é€šè¿‡

## åŸºæœ¬æ“ä½œ
```bash
cd /Users/CodeProjects/VoiceX/worker
./run_worker.sh              
./run_worker.sh restart       
./run_worker.sh logs         
./run_worker.sh status 
./run_worker.sh clean      
```